"use strict";window.addEventListener("DOMContentLoaded",(function(){var t=document.querySelectorAll("#xf-MusicPlayer");if(0===t.length)return;if("function"!=typeof Symbol||"function"!=typeof Promise||"function"!=typeof Object.assign||"function"!=typeof Array.from||"function"!=typeof Array.prototype.includes||"[object Object]"!=={}.toString.call({})||!0!==Array.isArray([]))return alert("当前浏览器不支持解析 ES6 语法, 无法使用“xf-MusicPlayer”插件, 请升级您的浏览器!"),void(window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href));const e=document.head,n=document.body;if(!document.querySelector('meta[name="viewport"]')){let t=document.createElement("meta");t.setAttribute("name","viewport"),t.setAttribute("content","width=device-width, initial-scale=1.0"),e.appendChild(t)}let s=[...t];s.length>1&&s.splice(1),s=s[0];let i=s.getAttribute("data-localMusic");const o=s.getAttribute("data-songList");let l=`${location.protocol}//${s.getAttribute("data-musicApi")}`.trim();if("null"===l.slice(-4)&&(l=`${location.protocol}//api.xfyun.club`),""===l&&null===i&&null===o)return void this.alert("请输入音乐API域名");!function(){const t=s.getAttribute("data-cdnName"),n=window.location;let i=null===t?`${n.protocol}//${n.hostname}${n.port?":"+n.port:""}`:t.trim();if("https:"===n.protocol){const t=document.createElement("meta");t.setAttribute("http-equiv","Content-Security-Policy"),t.setAttribute("content","upgrade-insecure-requests"),e.appendChild(t)}const o=s.getAttribute("data-filePath");null!==o&&(i+=`/${a=o,a.replace(/(^[^a-zA-Z0-9]+)|([^a-zA-Z0-9]+$)/g,"")}`);var a;const c=n=>{const s=document.createElement("link");return s.rel="stylesheet",s.href=n,null!==t&&""!==t?e.appendChild(s):new Promise(((t,i)=>{fetch(n).then((o=>{o.ok?(e.appendChild(s),t()):i(`链接不可用: ${n}`)})).catch((t=>{i(`发生错误：${t}`)}))}))};let r=`${i}/xf-MusicPlayer/icon/xfplayIcon.min.css`,u=`${i}/xf-MusicPlayer/css/xf-MusicPlayer.min.css`;"file:"===location.protocol&&(r="https://player.xfyun.club/js/xf-MusicPlayer/icon/xfplayIcon.min.css",u="https://player.xfyun.club/js/xf-MusicPlayer/css/xf-MusicPlayer.min.css",l="https://api.xfyun.club");Promise.all([c(r),c(u)]).catch((t=>{s.remove(),console.error(t),alert("请把插件放在网页根目录，否则无法运行【xf-MusicPlayer.js】插件！")}))}(),function(){const t=(t,e)=>{let n=(new DOMParser).parseFromString(t,"text/html");n=n.body.firstChild,e.appendChild(n)};t('<div class="xf-MusicPlayer-Main">\n    <div class="xf-switchPlayer">\n        <i class="xficon icon-jiantou2"></i>\n    </div>\n    <div class="xf-insideSong">\n        <div class="xf-musicControl">\n            <div class="xf-topControl">\n\n            <div class="xf-musiCover">  \n              <img src="" alt="" class="xf-musicPhoto">\n            </div>\n\n                <div class="xf-introduce">\n                    <h3 class="xf-songName"></h3>\n                    <p class="xf-singer"></p>\n                </div>\n\n                <div class="xf-songPicture">\n                <img src="https://player.xfyun.club/img/playerLoad.gif" alt="加载中..." class="xf-musicPicture">\n                <i class="xf-musicalNote xficon icon-yinle"></i>\n                <i class="xf-musicalNote xficon icon-yinle"></i>\n                <i class="xf-musicalNote xficon icon-yinle"></i>\n               </div>\n\n                <ul class="xf-playerControl">\n                    <li class="xf-previousSong">\n                        <i class="xficon icon-shangyishou"></i>\n                    </li>\n                    <li class="xf-playbackControl">\n                        <i class="xf-pause xficon icon-zantingtingzhi" style="display: none;"></i>\n                        <i class="xf-playBack xficon icon-bofang" style="display: block;"></i></li>\n                    <li class="xf-nextSong"><i class="xficon icon-xiayishou"></i></li>\n                </ul>\n\n\n                <ul class="xf-bottomControl">\n                <li class="xf-audioFrequency"><i class="xficon icon-shengyin-kai"></i></li>\n                <li class="xf-progressBar">\n                    <h5 class="xf-totalAudioProgress">\n                        <p class="xf-audioProgress" style="width: 0;"></p>\n                    </h5>\n                </li>\n                <li class="xf-playlistBtn"><i class="xficon icon-gedan"></i>\n                </li>\n            </ul>\n\n\n            </div>\n\n        </div>\n    </div>\n    <div class="xf-outsideSongList">\n        <ul class="xf-listOfSongs"></ul>\n    </div>\n</div>',s),function(){const e=document.createElement("audio");e.id="xf-musicAudio",n.appendChild(e);const a=document.getElementById("xf-musicAudio");a.controls=0,null===i&&t('<div id="xf-lyric"><ul class="xf-AllLyric-box"></ul></div>',n);const c=t=>new Promise((e=>setTimeout(e,t))),r=()=>a.play().catch((t=>console.warn(`浏览器默认限制了自动播放：${t}`))),u=()=>a.pause(),d=t=>s.querySelector(t),f=d(".xf-MusicPlayer-Main"),m=d(".xf-switchPlayer"),x=m.querySelector(".icon-jiantou2"),g=d(".xf-musicPicture"),y=d(".xf-musicPhoto"),p=d(".xf-songName"),h=d(".xf-singer"),v=d(".xf-previousSong"),b=d(".xf-playbackControl"),L=b.querySelector(".xf-pause"),w=b.querySelector(".xf-playBack"),S=d(".xf-nextSong"),A=d(".xf-audioFrequency"),k=d(".xf-totalAudioProgress"),$=d(".xf-audioProgress"),C=d(".xf-playlistBtn"),E=d(".xf-outsideSongList"),P=d(".xf-listOfSongs"),M=s.querySelectorAll(".xf-musicalNote"),I=n.querySelector("#xf-lyric"),q=s.getAttribute("data-themeColor");null===q?f.classList.add("xf-original"):f.classList.add(q);const T=s.getAttribute("data-bottomHeight");T&&(f.style.bottom=T);const N=()=>{const t=n.querySelectorAll("img[data-musicLjz-src]"),e=new IntersectionObserver(((t,e)=>{t.forEach((t=>{if(t.isIntersecting){const n=t.target,s=n.getAttribute("data-musicLjz-src");n.setAttribute("src",s),n.onload=()=>{e.unobserve(n),n.removeAttribute("data-musicLjz-src")}}}))}));t.forEach((t=>e.observe(t)))},j=()=>{L.style.display="none",w.style.display="block",b.classList.remove("xf-bePlaying"),g.classList.add("xf-pauseRotation"),y.classList.add("xf-pauseRotation"),M.forEach((t=>t.classList.add("xf-pausePdyMove"))),null===i&&(I.classList.add("xf-lyricHidden"),I.classList.remove("xf-lyricShow"))},O=()=>{L.style.display="block",w.style.display="none",b.classList.add("xf-bePlaying"),g.classList.remove("xf-pauseRotation"),y.classList.remove("xf-pauseRotation"),M.forEach((t=>t.classList.remove("xf-pausePdyMove"))),null===i&&(I.classList.remove("xf-lyricHidden"),I.classList.add("xf-lyricShow"))},z=["rgba(85, 0, 255, .35)","rgba(0, 225, 255, .35)","rgba(255, 165, 0, .35)","rgba(0, 100, 0, .35)","rgba(80, 0, 0, .35)","rgba(255, 192, 203, .35)"],D={"xf-original":0,"xf-sky":1,"xf-orange":2,"xf-darkGreen":3,"xf-wineRed":4,"xf-girlPink":5}[q]??0;let B,R=0;const H=async t=>{if(R)return;B||(B=document.createElement("div"),B.classList.add("xf-music-pop"),n.appendChild(B)),B.textContent=t;const e=B.style,s=z[D];Object.assign(e,{backgroundColor:s}),R=1,e.left="-100%",await c(500),e.left=0,await c(2500),e.left="-100%",R=0};async function J(t,e="GET",n={},s=null){try{const i=await fetch(t,{method:e,headers:n,body:s});return await i.json()}catch(t){throw t}}(async()=>{null!==s.getAttribute("data-fadeOutAutoplay")?(a.autoplay=!0,await c(1e3),(async()=>{await c(2e3),a.paused?(console.warn("您的浏览器不支持自动播放音乐，请手动点击播放器继续欣赏歌曲吧~"),j()):(H(`正在播放：${p.textContent}`),O())})(),x.classList.add("xf-jiantou1"),f.classList.add("xf-playerShow"),r()):j()})();let U=s.getAttribute("data-songChart")||"热歌榜";const F=s.getAttribute("data-randomSongList");if(""===F||"1"===F||"true"===F){let t=["热歌榜","新歌榜","原创榜","飙升榜"];U=t[Math.floor(Math.random()*t.length)]}i&&(U="本地"),console.log(`%c 正在播放${U}歌单~`,"color: #b3c4ec;");const G=null===i&&null===o?`${l}/musicAll/?sortAll=${U.trim()}`:null===i&&null!==o?`${l}/musicAll/?playlistId=${o.trim()}`:i.trim(),X=t=>t<10?`0${t}`:t;(()=>{let e=!1;const d=()=>{s.getElementsByClassName("xf-bePlaying").length>0?(H("音乐已暂停"),u(),j()):(H(`正在播放：${p.textContent}`),r(),O(),e=!0)};b.addEventListener("click",d),window.addEventListener("keyup",(t=>{" "!==(t=event).key&&32!==t.keyCode||d()})),A.addEventListener("click",(function(){a.muted=!a.muted,a.muted?(H("开启静音"),this.children[0].classList.remove("icon-shengyin-kai"),this.children[0].classList.add("icon-shengyin-guan")):(H("取消静音"),this.children[0].classList.add("icon-shengyin-kai"),this.children[0].classList.remove("icon-shengyin-guan"))})),f.style.opacity=0,(async(t,e,n)=>{const s=window.getComputedStyle(t);await c(1e3),s.getPropertyValue(e)===n&&(H("播放器加载中..."),a.src="",g.src="",y.src="",p.textContent="",h.textContent="",g.alt="",y.alt="",P.innerHTML="")})(f,"opacity","0");let m=0;const x=async()=>{try{let n=await J(G);null===i&&null!==o&&(n=n.playlist.tracks),await Promise.all(n.map((async e=>{const n=e.id,s=e.name,o=e.artistsname||e.al.name,a=e.picurl||e.al.picUrl,c=e.url||`${l}/musicAll/?songId=${n}&mp3Url=mp3`,r=null===i?void 0!==e.duration?function(t){const e=Math.floor(t/60),n=Math.floor(t%60);return`${X(e)}:${X(n)}`}(e.duration):(u=e.dt,`${X(Math.floor(u/6e4))}:${X(Math.floor(u%6e4/1e3))} `):e.musicDuration;var u;t(`<li class="xf-songsItem"data-index="${n}"data-mp3url="${c}"><div class="xf-songListSongPictures"><i class="xf-songIcon xficon icon-bofang"></i><img data-musicLjz-src="${a+"?param=200x200"}"src="https://player.xfyun.club/img/playerLoad.gif"alt="songPicture"class="xf-playlistImg"></div><div class="xf-playlistSongInformation"><div class="xf-songTitle"><h5 class="xf-songName">${s}</h5><p class="xf-authorAndDuration"><sapn class="xf-songAuthor">${o}</sapn><span class="xf-songLength xficon icon-shijian">\t${r}</span></p></div></div></li>`,P)})));const d=()=>new Promise((t=>{const e=Date.now(),i=setInterval((()=>{m=s.querySelectorAll(".xf-songsItem").length;const o=n.length;if(m===o){clearInterval(i);const n=Date.now();t(n-e)}}),30)})),x=(t,e,n)=>{const s=new Date;s.setTime(s.getTime()+24*n*60*60*1e3);const i=`expires=${s.toUTCString()}`;document.cookie=`${t}=${e}; ${i}; path=/`},b=t=>{const e=`${t}=`,n=document.cookie.split(";");for(let t of n){for(;" "===t.charAt(0);)t=t.substring(1);if(0===t.indexOf(e))return t.substring(e.length,t.length)}return null},L=t=>document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",w="xf-MusicPlayer",A=s.getAttribute("data-memory");let k=null;const C=b(w),E=t=>{"1"===A||"true"===A?t():C&&L(w)};d().then((async t=>{await c(t),t<=100?console.log(`%c 播放器接口加载耗时【正常】：${t}ms`,"color: #60a060"):t<=5e3?console.log(`%c 播放器接口加载耗时【稍慢】：${t}ms`,"color: #ffb87a"):(console.error("%c 播放器接口加载异常！","color: #a51212"),s.remove());let o=s.querySelectorAll(".xf-songsItem");if(0===o.length)return void console.error("歌曲未被添加...");let d=0;const m=(b=0,L=o.length,Math.floor(Math.random()*(L-b+1))+b);var b,L;const A=s.getAttribute("data-random");null!==A&&"false"!==A&&(d=""===A||isNaN(Number(A))?m:Number(A)>0&&A<=o.length?Number(A)-1:0),E((()=>{if(C){const{musicId:t}=JSON.parse(C);d=t>n.length?0:t}else k={musicId:0,musicTime:0},x(w,JSON.stringify(k),30)}));const P=t=>{f.style.opacity=1;let n="";o.forEach(((e,s)=>{e.classList.toggle("xf-inExecution",s===t);const i=Array.from(o).filter((t=>t.classList.contains("xf-inExecution")));n=i,e.querySelector(".xf-songListSongPictures .xf-songIcon").classList.remove("icon-zantingtingzhi")}));const c=o[t],u=c.querySelector(".xf-playlistImg")?.getAttribute("data-musicljz-src")??c.querySelector(".xf-playlistImg")?.src,d=c.dataset.mp3url,m=c.querySelector(".xf-songName").textContent,x=c.querySelector(".xf-songAuthor").textContent;a.src=d,g.src=u,g.alt=m,y.src=u,y.alt=m,p.textContent=m,h.textContent=x,n[0].querySelector(".xf-songListSongPictures .xf-songIcon").classList.add("icon-zantingtingzhi"),(e||null!==s.getAttribute("data-fadeOutAutoplay"))&&(r(),O(),H(`正在播放：${m}`));const v=s.getAttribute("data-lyrics");if(null===i&&"0"!==v&&"false"!==v){I.style.backgroundColor=z[D];let t=I.querySelector(".xf-AllLyric-box");const e=n[0].dataset.index;J(`${l}/musicAll/?lyric=${e}`).then((e=>{if(t.innerHTML="",200===e.code){const n=e.lrc.lyric.split("\n").map((t=>{const e=t.indexOf("]");return-1!==e?{time:s(t.substring(1,e)),text:t.substring(e+1).trim()}:null})).filter((t=>null!==t));function s(t){const[e,n]=t.split(":").map(parseFloat);return 60*e+n}function i(){const e=a.currentTime;for(let e=0;e<n.length;e++){const n=t.children[e];n&&n.classList.remove("xf-textShow")}let s;for(let t=0;t<n.length;t++)if(e>=n[t].time){if(s=t,t<n.length-1&&e>=n[t+1].time)continue;break}const i=t.children[s];i&&i.classList.add("xf-textShow")}n.forEach((e=>{const n=document.createElement("li");n.classList.add("xf-ly"),n.textContent=e.text,t.appendChild(n)})),a.removeEventListener("timeupdate",i),a.addEventListener("timeupdate",i)}})).catch((t=>console.error(`歌词获取失败：${t}`)))}};P(d);const M=t=>{E((()=>{k={musicId:t,musicTime:0},x(w,JSON.stringify(k),30)}))},q=()=>{e=!0,d=(d-1+o.length)%o.length,P(d),M(d)},T=()=>{e=!0,d=(d+1)%o.length,P(d),M(d)};o.forEach(((t,n)=>{t.addEventListener("click",(()=>{e=!0,d=n,P(d),M(d)}))})),S.addEventListener("click",T),v.addEventListener("click",q),window.addEventListener("keyup",(t=>{"ArrowRight"!==(t=event).key&&39!==t.keyCode||(e=!0,d=(d+o.length+2)%o.length,P(d),M(d)),"ArrowLeft"!==t.key&&37!==t.keyCode||q()})),a.addEventListener("timeupdate",(()=>{const t=a.duration,e=a.currentTime/t*100;$.style.width=`${e}%`,E((()=>{k={musicId:d,musicTime:a.currentTime},x(w,JSON.stringify(k),30)})),100===e&&T()}));const B=()=>{E((()=>{if(!C)return;const{musicTime:t}=JSON.parse(C),e=a.duration;a.currentTime=t>=e?0:t,r()})),a.removeEventListener("loadedmetadata",B)};a.addEventListener("loadedmetadata",B),""!==g.src&&""!==y.src&&""!==p.textContent||(T(),u(),j(),H("音乐已停止播放！")),N()}))}catch(t){console.error(`发生错误：${t}`)}};x();const L=setTimeout((()=>{const t=[...P.querySelectorAll(".xf-songsItem")];0===t.length||"0"===f.style.opacity||t.length<m?(console.warn("检测元素渲染异常，计划重新执行中..."),P.innerHTML="",x(),N(),clearTimeout(L)):(console.log("%c DOM元素渲染成功!","color: skyblue"),clearTimeout(L))}),3e3);let w=!1;const M=t=>{if(!w)return;const e=k.getBoundingClientRect(),n=(t.clientX-e.left)/e.width*100/100*a.duration;a.currentTime=n},q=()=>{w=!1};k.addEventListener("mousedown",(t=>{w=!0,M(t),r(),O()})),k.addEventListener("mousemove",M),k.addEventListener("mouseup",q),k.addEventListener("mouseleave",q),C.addEventListener("click",(()=>{s.getElementsByClassName("xf-outsideSongListShow").length?E.classList.remove("xf-outsideSongListShow"):E.classList.add("xf-outsideSongListShow")})),(()=>{{const t=document.createElement("div");t.classList.add("xf-throughDisplay"),n.appendChild(t)}const t=document.querySelector(".xf-throughDisplay"),e=[v,b,S,A,C];function s(e){const n=e.pageX,s=e.pageY;switch(t.style.left=`${n+15}px`,t.style.top=`${s}px`,this){case v:i("上一首");break;case b:i("播放音乐");break;case S:i("下一首");break;case A:i("音量设置");break;case C:i("查看歌单");break;default:o()}}const i=e=>{t.style.display="block",t.textContent=e},o=()=>t.style.display="none";for(let t=0;t<e.length;t++){const n=e[t];n.addEventListener("mouseenter",s),n.addEventListener("mouseleave",o),n.addEventListener("click",o)}})()})(),m.addEventListener("click",(()=>{x.classList.toggle("xf-jiantou1"),f.classList.toggle("xf-playerShow")})),document.addEventListener("click",(function(t){s.contains(t.target)||(x.classList.remove("xf-jiantou1"),f.classList.remove("xf-playerShow"))})),a.remove()}()}();const a=["padding: 5px 10px; border-radius: 5px 0 0 5px; background-color: #8b52ec; font-weight: bold;","padding: 5px 10px; border-radius: 0 5px 5px 0; background-color: #a17eff; font-weight: bold;"];console.log("%c小枫网络%chttps://www.xfabe.com/",a[0],a[1])}));